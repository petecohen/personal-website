---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Get all weeknotes, filter out drafts, and sort by date descending
const allWeeknotes = await getCollection('weeknotes', ({ data }) => {
  return data.draft !== true;
});

const sortedWeeknotes = allWeeknotes.sort((a, b) =>
  b.data.date.valueOf() - a.data.date.valueOf()
);

// Group by year
const weeknotesByYear = sortedWeeknotes.reduce((acc, weeknote) => {
  const year = weeknote.data.year;
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(weeknote);
  return acc;
}, {} as Record<number, typeof sortedWeeknotes>);

const years = Object.keys(weeknotesByYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<Layout
  title="Weeknotes - Pete Cohen"
  description="Weekly notes and reflections"
>
  <div class="max-w-4xl mx-auto px-6 py-16">
    <div class="mb-12">
      <h1 class="text-4xl font-bold mb-4">Weeknotes</h1>
      <p class="text-lg text-[var(--color-text-muted)]">
        Weekly reflections on work, life, and things I'm learning.
        <a href="/weeknotes/feed.xml" class="text-[var(--color-accent)] hover:text-[var(--color-accent-hover)]">Subscribe via RSS</a>
      </p>
    </div>

    {years.map(year => (
      <div class="mb-12">
        <h2 class="text-2xl font-semibold mb-6">{year}</h2>
        <div class="space-y-6">
          {weeknotesByYear[year].map(weeknote => (
            <article class="border-b border-[var(--color-border)] pb-6">
              <a href={`/weeknotes/${weeknote.data.year}/week-${String(weeknote.data.weekNumber).padStart(2, '0')}`} class="group">
                <h3 class="text-xl font-medium mb-2 group-hover:text-[var(--color-accent)] transition-colors">
                  {weeknote.data.title}
                </h3>
                <time class="text-sm text-[var(--color-text-muted)] block mb-2">
                  {weeknote.data.date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </time>
                {weeknote.data.summary && (
                  <p class="text-[var(--color-text-muted)]">
                    {weeknote.data.summary}
                  </p>
                )}
              </a>
            </article>
          ))}
        </div>
      </div>
    ))}
  </div>
</Layout>
